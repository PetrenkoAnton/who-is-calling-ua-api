 name: Laravel 7, MariaDb, & Redis CI

  on:
    push:
      branches:
        - main
        - dev
    pull_request:
      branches:
        - main
        - dev

  jobs:
    continuous-integration:
      name: Laravel (PHP 8.3)
      runs-on: ubuntu-latest

      env:
        DB_DATABASE: laravel
        DB_USERNAME: root
        DB_PASSWORD: password
        DB_HOST: 127.0.0.1
        DB_PORT: 32574
        REDIS_PORT: 6379
        BROADCAST_DRIVER: log
        CACHE_DRIVER: redis
        QUEUE_CONNECTION: redis
        SESSION_DRIVER: redis
        MYSQL_ALLOW_EMPTY_PASSWORD: false
        MYSQL_ROOT_PASSWORD: password
        MYSQL_DATABASE: laravel
      services:
        redis:
          image: redis
          ports:
            - 6379/tcp
          options: --health-cmd="redis-cli ping" --health-interval=10s --health-timeout=5s --health-retries=3

      steps:
        - name: Checkout
          uses: actions/checkout@v2

        - name: Setup PHP, with composer and extensions
          uses: shivammathur/setup-php@v2
          with:
            php-version: 8.3
            extensions: mbstring, dom, fileinfo, mysql, libxml, xml, xmlwriter, dom, tokenizer, filter, json, phar, pcre, openssl, pdo, intl, curl
            coverage: xdebug

        - name: Install Composer dependencies
          run: composer install --no-progress --no-suggest --prefer-dist --optimize-autoloader

        - name: Prepare the application
          run: php -r "copy('.env.testing', '.env');"

        - name: Test with phpunit
          run: vendor/bin/phpunit
